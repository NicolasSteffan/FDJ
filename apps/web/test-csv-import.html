<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Import CSV EuroMillions</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid #9b59b6;
            color: #9b59b6;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: rgba(155, 89, 182, 0.3);
        }
        
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2ecc71;
        }
        
        .stat-label {
            font-size: 12px;
            color: #bdc3c7;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Test Import CSV EuroMillions</h1>
        
        <div class="test-section">
            <h3>📁 Test avec fichier spécifique</h3>
            <p>Chemin : <code>Z:\euromillions_202002.csv</code></p>
            <button class="btn" onclick="testSpecificFile()">🚀 Tester Import Automatique</button>
            <button class="btn" onclick="testMapping()">🔍 Tester Mapping</button>
            <button class="btn" onclick="clearLogs()">🗑️ Clear Logs</button>
        </div>
        
        <div class="test-section">
            <h3>📊 Statistiques du test</h3>
            <div class="stats" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number" id="totalLines">-</div>
                    <div class="stat-label">Lignes CSV</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="importedCount">-</div>
                    <div class="stat-label">Importés</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="skippedCount">-</div>
                    <div class="stat-label">Ignorés</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="errorCount">-</div>
                    <div class="stat-label">Erreurs</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>📝 Logs de test</h3>
            <div class="log-output" id="logOutput">
                📡 Prêt pour les tests d'import CSV...<br/>
                💡 Cliquez sur "Tester Import Automatique" pour commencer<br/>
            </div>
        </div>
    </div>

    <!-- Import des modules -->
    <script src="csv-import.js"></script>
    
    <script>
        // Fonction pour ajouter des logs
        function addLog(message, type = 'info') {
            const output = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                warn: '#ffff00', 
                error: '#ff0000',
                success: '#2ecc71'
            };
            
            output.innerHTML += `<span style="color: ${colors[type] || '#00ff00'}">[${timestamp}] ${message}</span><br/>`;
            output.scrollTop = output.scrollHeight;
        }
        
        // Mettre à jour les statistiques
        function updateStats(stats) {
            document.getElementById('totalLines').textContent = stats.total || '-';
            document.getElementById('importedCount').textContent = stats.imported || '-';
            document.getElementById('skippedCount').textContent = stats.skipped || '-';
            document.getElementById('errorCount').textContent = stats.errors || '-';
        }
        
        // Tester avec le fichier spécifique
        async function testSpecificFile() {
            addLog('🚀 Début test import fichier spécifique...', 'info');
            addLog('📁 Fichier cible: Z:\\euromillions_202002.csv', 'info');
            
            try {
                // Simuler la lecture du fichier (en réalité il faudrait le sélectionner via input file)
                addLog('⚠️ Pour tester réellement, utilisez le sélecteur de fichier dans l\'application principale', 'warn');
                addLog('📍 Aller à: Page Scrapping → Fichier source → Sélectionner le CSV', 'info');
                addLog('🎯 Le mapping est automatiquement appliqué pour les fichiers .csv', 'info');
                
                // Afficher le mapping configuré
                addLog('📋 Mapping configuré:', 'info');
                addLog(`   📅 Date: colonne 2 (date_de_tirage) DD/MM/YYYY → YYYY-MM-DD`, 'info');
                addLog(`   🎱 Numéros: colonnes 5-9 (boule_1 à boule_5) → "1,2,3,4,5"`, 'info');
                addLog(`   ⭐ Étoiles: colonnes 10-11 (etoile_1, etoile_2) → "1,2"`, 'info');
                addLog(`   💰 Gains: rangs 1-13 avec nombres gagnants et rapports`, 'info');
                addLog(`   🏷️ Source: "import" pour tous les enregistrements`, 'info');
                
            } catch (error) {
                addLog(`❌ Erreur test: ${error.message}`, 'error');
            }
        }
        
        // Tester le mapping
        function testMapping() {
            addLog('🔍 Test du mapping CSV...', 'info');
            
            // Exemple de ligne CSV du fichier
            const sampleLine = '25065;VENDREDI;15/08/2025;17;13/11/2025;36;40;35;30;13;6;2;-13-30-35-36-40-;-2-6-;0;0;0;0;2;592222,90;2;13;21294,10;16;63;1368,60;203;1023;155,20;540;2481;67,60;485;2339;50,40;8978;40120;14,70;10232;48421;13,50;23213;109005;11,20;55801;234111;6,30;168516;759032;6,10;366018;1688844;4,40;0;0;9;525,90;96;27,30;246;10,60;3968;1,60;4796;3,60;25162;3,20;44960;8,50;77998;2,70;824436;2,30;JZ 186 6062;;';
            
            addLog('📝 Ligne CSV d\'exemple:', 'info');
            addLog(sampleLine.substring(0, 100) + '...', 'info');
            
            // Test de parsing
            try {
                const columns = sampleLine.split(';');
                
                // Extraction selon le mapping
                const date = columns[2]; // "15/08/2025"
                const convertedDate = convertDateFormat(date); // "2025-08-15"
                const numeros = [columns[5], columns[6], columns[7], columns[8], columns[9]]; // boules
                const etoiles = [columns[10], columns[11]]; // étoiles
                
                addLog('✅ Parsing réussi:', 'success');
                addLog(`   📅 Date: ${date} → ${convertedDate}`, 'info');
                addLog(`   🎱 Numéros: [${numeros.join(', ')}] → "${numeros.join(',')}"`, 'info');
                addLog(`   ⭐ Étoiles: [${etoiles.join(', ')}] → "${etoiles.join(',')}"`, 'info');
                
                // Test gains (exemple rang 2)
                const gagnants_rang2 = columns[19]; // nombre_de_gagnant_au_rang2_Euro_Millions_en_europe
                const rapport_rang2 = columns[19]; // rapport_du_rang2_Euro_Millions
                
                addLog(`   💰 Exemple gain rang 2: ${gagnants_rang2} gagnants, ${rapport_rang2}`, 'info');
                
                updateStats({
                    total: 1,
                    imported: 1,
                    skipped: 0,
                    errors: 0
                });
                
            } catch (error) {
                addLog(`❌ Erreur parsing: ${error.message}`, 'error');
                updateStats({
                    total: 1,
                    imported: 0,
                    skipped: 0,
                    errors: 1
                });
            }
        }
        
        // Fonction utilitaire pour convertir les dates
        function convertDateFormat(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        
        // Clear logs
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '📡 Logs effacés...<br/>';
            updateStats({ total: '-', imported: '-', skipped: '-', errors: '-' });
        }
        
        addLog('✅ Module de test CSV chargé', 'success');
        addLog('🎯 Mapping EuroMillions configuré et prêt', 'success');
    </script>
</body>
</html>
